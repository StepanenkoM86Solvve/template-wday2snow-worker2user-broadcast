<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:core="http://www.mulesoft.org/schema/mule/core"
	xmlns:json="http://www.mulesoft.org/schema/mule/json" xmlns:batch="http://www.mulesoft.org/schema/mule/batch"
	xmlns:data-mapper="http://www.mulesoft.org/schema/mule/ee/data-mapper"
	xmlns:scripting="http://www.mulesoft.org/schema/mule/scripting"
	xmlns:wd-hr="http://www.mulesoft.org/schema/mule/wd-hr" xmlns:sfdc="http://www.mulesoft.org/schema/mule/sfdc"
	xmlns:wd-staffing="http://www.mulesoft.org/schema/mule/wd-staffing"
	xmlns:servicenow="http://www.mulesoft.org/schema/mule/servicenow"
	xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:spring="http://www.springframework.org/schema/beans" version="EE-3.5.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/json http://www.mulesoft.org/schema/mule/json/current/mule-json.xsd
http://www.mulesoft.org/schema/mule/scripting http://www.mulesoft.org/schema/mule/scripting/current/mule-scripting.xsd
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd
http://www.mulesoft.org/schema/mule/servicenow http://www.mulesoft.org/schema/mule/servicenow/current/mule-servicenow.xsd
http://www.mulesoft.org/schema/mule/wd-staffing http://www.mulesoft.org/schema/mule/wd-staffing/2.0/mule-wd-staffing.xsd
http://www.mulesoft.org/schema/mule/sfdc http://www.mulesoft.org/schema/mule/sfdc/current/mule-sfdc.xsd
http://www.mulesoft.org/schema/mule/wd-hr http://www.mulesoft.org/schema/mule/wd-hr/2.0/mule-wd-hr.xsd
http://www.mulesoft.org/schema/mule/ee/data-mapper http://www.mulesoft.org/schema/mule/ee/data-mapper/current/mule-data-mapper.xsd
http://www.mulesoft.org/schema/mule/batch http://www.mulesoft.org/schema/mule/batch/current/mule-batch.xsd">

	<servicenow:config name="ServiceNow" username="${snow.user}"
		password="${snow.password}" serviceEndpoint="${snow.endpoint}"
		doc:name="ServiceNow">
		<servicenow:connection-pooling-profile
			initialisationPolicy="INITIALISE_ONE" exhaustedAction="WHEN_EXHAUSTED_GROW" />
		<reconnect />
	</servicenow:config>
	<wd-hr:config name="Workday_Human_Resource" hrUser="${wday.user}"
		hrPassword="${wday.password}" hrEndpoint="${wday.endpoint}" doc:name="Workday Human Resource">
		<wd-hr:connection-pooling-profile
			initialisationPolicy="INITIALISE_ONE" exhaustedAction="WHEN_EXHAUSTED_GROW" />
	</wd-hr:config>
	<data-mapper:config name="pojo_to_pojo"
		transformationGraphPath="pojo_to_pojo.grf" doc:name="pojo_to_pojo" />
	<batch:job name="businessLogicBatch1">
		<batch:threading-profile poolExhaustedAction="WAIT" />
		<batch:input>
			<wd-hr:get-workers config-ref="Workday_Human_Resource"
				doc:name="get Workers from Workday Human Resource"
				workersRequest-ref="#[org.mule.kicks.WorkersRequest.create()]" />
			<set-payload value="#[payload.responseData.worker]"
				doc:name="set to Woker collection" />
		</batch:input>
		<batch:process-records>
			<batch:step name="foreachWorkerInWorkdayCreateUserInServiceNow">
				<data-mapper:transform config-ref="pojo_to_pojo"
					doc:name="WorkDay Worker to ServiceNow User" />
                <servicenow:insert-user config-ref="ServiceNow"
        			doc:name="ServiceNow">
        		</servicenow:insert-user>
			</batch:step>
		</batch:process-records>
		<batch:on-complete>
			<logger
				message="Total records: #[payload.totalRecords], successful records: #[payload.successfulRecords], failed records: #[payload.failedRecords]"
				level="ERROR" doc:name="log results" />
		</batch:on-complete>
	</batch:job>

</mule>
